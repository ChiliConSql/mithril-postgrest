/*
    A Mithril.js plugin to authenticate requests against PostgREST
    Copyright (c) 2007 - 2015 Diogo Biazus
    Licensed under the MIT license (http://digitalbush.com/projects/masked-input-plugin/#license)
    Version: 1.0.0
*/
!function(a){"object"==typeof exports?a(require("mithril"),require("underscore"),require("node-localstorage")):a(m,_,localStorage)}(function(a,b,c){var d={},e=function(a){return a.setRequestHeader("Authorization","Bearer "+f()),a},f=function(a){return a?c.setItem("postgrest.token",a):c.getItem("postgrest.token")};d.reset=function(){c.removeItem("postgrest.token")},d.paginationVM=function(c,d){var e=a.prop([]),f=d||"id.desc",g=a.prop({order:f}),h=a.prop(!1),i=a.prop(1),j=function(){var d=a.deferred();return h(!0),a.redraw(),a.startComputation(),c(i(),g()).then(function(c){e(b.union(e(),c)),h(!1),d.resolve(e()),a.endComputation()}),d.promise},k=function(a){return g(b.extend({order:f},a)),e([]),i(1),j()},l=function(){return i(i()+1),j()};return{collection:e,filter:k,isLoading:h,nextPage:l}},d.filtersVM=function(c){var d=b.reduce(c,function(b,c,d){return"between"===c?b[d]={lte:a.prop(""),gte:a.prop("")}:b[d]=a.prop(""),b},{order:a.prop()}),e=function(){var a=function(){return d.order()&&b.reduce(d.order(),function(a,b,c){return a.push(c+"."+b),a},[]).join(",")};return b.reduce(d,function(d,e,f){if(a()&&(d.order=a()),"order"!==f){var g=c[f];if(b.isFunction(e)&&!e())return d;if("ilike"===g||"like"===g)d[f]=g+".*"+e()+"*";else if("between"===g){if(!e.lte()&&!e.gte())return d;d[f]=[],e.gte()&&d[f].push("gte."+e.gte()),e.lte()&&d[f].push("lte."+e.lte())}else d[f]=g+"."+e()}return d},{})};return b.extend({},d,{parameters:e})},d.init=function(c,g){return d.request=function(d){return a.request(b.extend(d,{url:c+d.url}))},d.model=function(c,d){var e=function(c){c=c||{},b.extend(this,b.reduce(d,function(b,d){return b[d]=a.prop(c[d]),b},{}))};e.pageSize=a.prop(10);var f=function(a){var b=function(){var b=(a-1)*e.pageSize(),c=b+e.pageSize()-1;return b+"-"+c};return function(a){a.setRequestHeader("Range-unit","items"),a.setRequestHeader("Range",b())}},g=function(a){return function(b,d){return a({method:"GET",url:"/"+c,data:d,config:f(b)})}};return e.getPageWithToken=g(a.postgrest.requestWithToken),e.getPage=g(a.postgrest.request),e},d.requestWithToken=function(c){return a.postgrest.authenticate().then(function(d){var f=b.isFunction(c.config)?b.compose(c.config,e):e;return a.postgrest.request(b.extend(c,{config:f}))})},d.authenticate=function(){var b=a.deferred();return f()?b.resolve({token:f()}):a.request(g).then(function(a){f(a.token),b.resolve({token:a.token})}),b.promise},d},a.postgrest=d});