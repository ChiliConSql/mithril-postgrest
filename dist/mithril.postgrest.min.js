/*
    A Mithril.js plugin to authenticate requests against PostgREST
    Copyright (c) 2007 - 2015 Diogo Biazus
    Licensed under the MIT license (http://digitalbush.com/projects/masked-input-plugin/#license)
    Version: 1.0.0
*/
!function(a){"object"==typeof exports?a(require("mithril"),require("underscore"),require("node-localstorage")):a(m,_,localStorage)}(function(a,b,c){var d={},e=function(a){return a.setRequestHeader("Authorization","Bearer "+f()),a},f=function(a){return a?c.setItem("postgrest.token",a):c.getItem("postgrest.token")};d.reset=function(){c.removeItem("postgrest.token")},d.paginationVM=function(c,d){var e=a.prop([]),f=d||"id.desc",g=a.prop({order:f}),h=a.prop(!1),i=a.prop(1),j=a.prop(),k=function(){var d=a.deferred(),f=function(a,c){if(a&&0!==a.status){var d=a.getResponseHeader("Content-Range");return b.isString(d)&&d.split("/").length>1&&j(parseInt(d.split("/")[1])),a.responseText}return"[]"};return h(!0),a.redraw(),a.startComputation(),c(i(),g(),{extract:f}).then(function(c){e(b.union(e(),c)),h(!1),d.resolve(e()),a.endComputation()},function(){h(!1),j(0),a.endComputation(),d.reject(arguments)}),d.promise},l=function(a){return g(b.extend({order:f},a)),e([]),i(1),k()},m=function(){return i(i()+1),k()};return{collection:e,filter:l,isLoading:h,nextPage:m,total:j}},d.filtersVM=function(c){var d=function(){var b=a.prop("");return b.toFilter=function(){return this()},b},e=b.reduce(c,function(a,b,c){return"between"===b?a[c]={lte:d(),gte:d()}:a[c]=d(),a},{order:a.prop()}),f=function(){var a=function(){return e.order()&&b.reduce(e.order(),function(a,b,c){return a.push(c+"."+b),a},[]).join(",")};return b.reduce(e,function(d,e,f){if(a()&&(d.order=a()),"order"!==f){var g=c[f];if(b.isFunction(e)&&!e())return d;if("ilike"===g||"like"===g)d[f]=g+".*"+e.toFilter()+"*";else if("@@"===g)d[f]=g+"."+e.toFilter().trim().replace(/\s+/g,"&");else if("between"===g){if(!e.lte.toFilter()&&!e.gte.toFilter())return d;d[f]=[],e.gte()&&d[f].push("gte."+e.gte.toFilter()),e.lte()&&d[f].push("lte."+e.lte.toFilter())}else d[f]=g+"."+e.toFilter()}return d},{})};return b.extend({},e,{parameters:f})},d.init=function(c,g){return d.onAuthFailure=a.prop(function(){}),d.request=function(d){return a.request(b.extend(d,{url:c+d.url}))},d.model=function(c,d){var e=function(c){c=c||{},b.extend(this,b.reduce(d,function(b,d){return b[d]=a.prop(c[d]),b},{}))};e.pageSize=a.prop(10);var f=function(a){var b=function(){var b=(a-1)*e.pageSize(),c=b+e.pageSize()-1;return b+"-"+c};return function(a){a.setRequestHeader("Range-unit","items"),a.setRequestHeader("Range",b())}},g=function(a){return function(d,e,g){return a(b.extend({method:"GET",url:"/"+c,data:e,config:f(d)},g))}};return e.getPageWithToken=g(a.postgrest.requestWithToken),e.getPage=g(a.postgrest.request),e},d.requestWithToken=function(c){return a.postgrest.authenticate().then(function(d){var f=b.isFunction(c.config)?b.compose(c.config,e):e;return a.postgrest.request(b.extend(c,{config:f}))})},d.authenticate=function(){var b=a.deferred();return f()?(b.resolve({token:f()}),b.promise):a.request(g).then(function(a){f(a.token)},d.onAuthFailure())},d},a.postgrest=d});