/*
    A Mithril.js plugin to authenticate requests against PostgREST
    Copyright (c) 2007 - 2015 Diogo Biazus
    Licensed under the MIT license 
    Version: 1.1.0
*/
!function(a){"object"==typeof exports?a(require("mithril"),require("underscore"),require("node-localstorage")):a(window.m,window._,window.localStorage)}(function(a,b,c){var d={},e=function(a){return a?c.setItem("postgrest.token",a):c.getItem("postgrest.token")},f=function(a,c){return c&&b.isFunction(c.config)?b.compose(c.config,a):a},g=function(a){return function(c){return b.each(a,function(a,b){c.setRequestHeader(b,a)}),c}},h=g({Prefer:"return=representation"});d.reset=function(){c.removeItem("postgrest.token")},d.loader=function(c,d,e){var e=e||!1,f=a.prop(e),g=a.deferred();return f.load=function(){return f(!0),d(b.extend({},c,{background:!0})).then(function(b){f(!1),g.resolve(b),a.redraw()},function(b){f(!1),g.reject(b),a.redraw()}),g.promise},f},d.loaderWithToken=function(a,b){return d.loader(a,d.requestWithToken,b)},d.init=function(c,i){return d.onAuthFailure=a.prop(function(){}),d.request=function(d){return a.request(b.extend({},d,{url:c+d.url}))},d.authenticate=function(){var b=a.deferred();return e()?(b.resolve({token:e()}),b.promise):a.request(i).then(function(a){e(a.token)},d.onAuthFailure())},d.requestWithToken=function(c){var d=g({Authorization:"Bearer "+e()});return a.postgrest.authenticate().then(function(){return a.postgrest.request(b.extend({},c,{config:f(d,c)}))})},d.model=function(c){var e=function(a,b){var c=function(){var c=(a-1)*b,d=c+b-1;return c+"-"+d};return g({"Range-unit":"items",Range:c()})},i=a.prop(10),j={url:"/"+c},k=function(a,c,d,g){return b.extend({},g,j,{method:"GET",data:a,config:f(e(c,d),g)})},l=function(b,c){return c.url+="?"+a.route.buildQueryString(b),c},m=function(c){return a.postgrest.request(b.extend({},c,j,{method:"OPTIONS"}))},n=function(a,c){return b.extend({},c,j,{method:"POST",data:a,config:f(h,c)})},o=function(a,c){return l(a,b.extend({},c,j,{method:"DELETE"}))},p=function(a,c,d){return l(a,b.extend({},d,j,{method:"PATCH",data:c,config:f(h,d)}))},q=function(a,b,c){return k(b,a,i(),c)},r=function(a,b){return k(a,1,1,b)};return{pageSize:i,getPageOptions:q,getRowOptions:r,patchOptions:p,postOptions:n,deleteOptions:o,getPage:b.compose(d.request,q),getRow:b.compose(d.request,r),patch:b.compose(d.request,p),post:b.compose(d.request,n),deleteRequest:b.compose(d.request,o),getPageWithToken:b.compose(d.requestWithToken,q),getRowWithToken:b.compose(d.requestWithToken,r),patchWithToken:b.compose(d.requestWithToken,p),postWithToken:b.compose(d.requestWithToken,n),deleteWithToken:b.compose(d.requestWithToken,o),options:m}},d},a.postgrest=d}),function(a){"object"==typeof exports?a(require("mithril"),require("underscore")):a(window.m,window._)}(function(a,b){a.postgrest.filtersVM=function(c){var d=function(){var b=a.prop("");return b.toFilter=function(){return(b()||"").toString().trim()},b},e=b.reduce(c,function(a,b,c){return"between"===b?a[c]={lte:d(),gte:d()}:a[c]=d(),a},{order:a.prop()}),f=function(){return b.reduce(e,function(a,d,e){if("order"!==e){var f=c[e];if(b.isFunction(d)&&!d())return a;if("ilike"===f||"like"===f)a[e]=f+".*"+d.toFilter()+"*";else if("@@"===f)a[e]=f+"."+d.toFilter().replace(/\s+/g,"&");else if("between"===f){if(!d.lte.toFilter()&&!d.gte.toFilter())return a;a[e]=[],d.gte()&&a[e].push("gte."+d.gte.toFilter()),d.lte()&&a[e].push("lte."+d.lte.toFilter())}else a[e]=f+"."+d.toFilter()}return a},{})},g=function(){var a=function(){return e.order()&&b.reduce(e.order(),function(a,b,c){return a.push(c+"."+b),a},[]).join(",")},c=a()?{order:a()}:{};return b.extend({},c,f())};return b.extend({},e,{parameters:g,parametersWithoutOrder:f})}}),function(a){"object"==typeof exports?a(require("mithril"),require("underscore")):a(window.m,window._)}(function(a,b){a.postgrest.paginationVM=function(c,d){var e=a.prop([]),f=d||"id.desc",g=a.prop({order:f}),h=a.prop(!1),i=a.prop(1),j=a.prop(),k=function(){var d=a.deferred(),f=function(a){if(!a||0===a.status)return JSON.stringify({hint:null,details:null,code:0,message:"Connection error"});var c=a.getResponseHeader("Content-Range");b.isString(c)&&c.split("/").length>1&&j(parseInt(c.split("/")[1]));try{return JSON.parse(a.responseText),a.responseText}catch(d){return JSON.stringify({hint:null,details:null,code:0,message:a.responseText})}};return h(!0),c(i(),g(),{background:!0,extract:f}).then(function(c){e(b.union(e(),c)),h(!1),d.resolve(e()),a.redraw()},function(b){h(!1),j(0),d.reject(b),a.redraw()}),d.promise},l=function(a){return g(b.extend({order:f},a)),e([]),i(1),k()},m=function(){return i(i()+1),k()};return{collection:e,firstPage:l,isLoading:h,nextPage:m,total:j}}});